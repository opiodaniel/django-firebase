{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cashier Payment Terminal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(255, 87, 34, 0.25);
    }
    .badge {
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-express {
      background-color: #ffeaa7;
      color: #d63031;
    }
    .badge-maintenance {
      background-color: #e8f8f5;
      color: #00b894;
    }
  </style>
  <script src="{% static 'js/js.cookie.min.js' %}"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body class="min-h-screen ">

  <header class="bg-white shadow-sm border-b border-gray-200 w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <img src="https://via.placeholder.com/120x40?text=SPARK+AUTOMOTIVE" alt="Spark Automotive Logo" class="h-10 object-contain" />
      <h1 class="text-2xl font-bold text-gray-800">Payment Terminal</h1>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <div class="flex-1">
          <h2 class="text-2xl font-semibold text-gray-800 mb-6">Customer & Vehicle Details</h2>

          <div class="space-y-4 text-gray-700">
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Client Name:</span>
              <span>{{ order_owner.name|default:"—" }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Phone:</span>
              <span>{{ order_owner.phone|default:"—" }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Vehicle:</span>
              <span>{{ vehicle_name|default:"—" }} <small class="text-gray-500">({{ vehicle_number_plate|default:"—" }})</small></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Mileage:</span>
              <span>{{ mileage|default:"—" }} km</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Order Type:</span>
              <span class="badge {% if order_type == 'Express' %}badge-express{% else %}badge-maintenance{% endif %}">
                {{ order_type|default:"—" }}
              </span>
            </div>
          </div>
        </div>
        <div class="flex-1 bg-gray-50 rounded-xl p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Financial Summary</h3>
          <div class="space-y-3 text-gray-700">
            <div class="flex justify-between">
              <span>Amount Due:</span>
              <strong class="text-2xl text-orange-600">Shs. <span id="amount-due-display">{{ amount_to_pay|default:"0"|add_commas }}</span></strong>
            </div>
            <div class="flex justify-between">
              <span>Amount Paid:</span>
              <span class="text-green-600">Shs. <span id="amount-paid-display">{{ amount_paid|default:"0"|add_commas }}</span></span>
            </div>
            <div id="change-display-row" class="flex justify-between">
              <span>Change Given:</span>
              <span class="text-blue-600">Shs. <span id="change-display">{{ change|default:"0"|add_commas }}</span></span>
            </div>
            <button id="printReceiptBtn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors transform shadow-md mt-4 {% if not amount_paid or amount_paid < amount_to_pay %}hidden{% endif %}">
              <i class="fas fa-print text-sm"></i>
              <span>Print Receipt</span>
            </button>
          </div>
        </div>
      </div>
    </div>


  <form id="payment-form" class="bg-white rounded-2xl shadow-lg p-8 mb-8">

    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Record Payment</h2>

    <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
      <div>
        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
          Amount Received (Shs.)
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-orange-600">
            Shs.
          </div>
          <input type="text"
                 id="amount"
                 name="amount_paid"
                 min="0"
                 step="100"
                 placeholder="0.00"
                 autocomplete="off"
                 required
                 class="w-full pl-10 pr-4 py-4 text-2xl font-bold text-gray-800 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300 placeholder-gray-300"
                 autofocus />
        </div>
      </div>

      <div class="flex items-end">
        <button
          id="confirmBtn"
          type="button"
          class="w-full bg-orange-500 text-white font-medium py-3 px-6 rounded-xl hover:bg-orange-600 transition-colors"
        >
          Confirm
        </button>
      </div>
    </div>

    <div class="mt-4 p-4 text-center">
        <button class="bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl hover:bg-gray-300 transition-colors transform">
          <a href="{% url 'order_list' %}">Cancel..)Back To Order List Page</a>
        </button>
    </div>

    {% if error %}
      <div class="mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl">
        {{ error }}
      </div>
    {% endif %}

   </form>

    <div class="bg-gray-100 rounded-2xl p-6 mt-8">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">🔌 WebSocket Debug (For Real-Time Client Screen)</h3>
      <div id="cashier-log" class="text-xs text-gray-600 font-mono h-40 overflow-y-auto bg-gray-50 p-4 rounded-lg mb-4"></div>

      <p class="text-sm text-gray-600 mb-3">Copy this link and paste into the client tablet:</p>
      <code class="block bg-gray-800 text-green-300 p-3 rounded-lg text-sm break-all">
        http://localhost:8000/client-screen?currentOrder={{ order_id }}
      </code>
      <button
        onclick="navigator.clipboard.writeText('http://localhost:8000/client-screen?currentOrder={{ order_id }}')"
        class="mt-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm"
      >
        Copy Client Link
      </button>
    </div>

    <div class="mt-6 text-center">
      <p class="text-sm text-gray-600">Scan to show on client device:</p>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://localhost:8000/client-screen?currentOrder={{ order.id }}" alt="QR Code" class="mx-auto mt-2">
    </div>

  </main>

  <div class="px-8 py-4 bg-gray-50 text-center text-xs text-gray-500 border-t border-gray-100 mt-8 w-full max-w-7xl mx-auto">
      © 2025 CashFlow Terminal | All payments secured with SSL
  </div>

  <div id="receiptTemplate" class="hidden">
    <style>
      body { font-family: monospace; background: #fff; margin: 0; padding: 0; }
      .receipt { background: #fff; max-width: 380px; margin: 0 auto; padding: 1.5rem; border: 1px solid #ddd; box-shadow: none; }
      .center { text-align: center; }
      h1 { font-size: 1.2rem; margin: 0; }
      .info p { margin: 2px 0; font-size: 0.9rem; }
      .dashed { border-top: 1px dashed #000; margin: 10px 0; }
      .details p { margin: 2px 0; display: flex; justify-content: space-between; }
      .section-title { font-weight: bold; margin-bottom: 4px; text-decoration: underline; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
      table th, table td { text-align: left; padding: 2px 0; }
      table td:last-child { text-align: right; }
      .summary p { display: flex; justify-content: space-between; font-weight: bold; margin: 4px 0; }
      .footer { text-align: center; font-size: 0.9rem; margin-top: 10px; }
      @media print {
        * { color: #000 !important; background: transparent !important; box-shadow: none !important; border-color: #000 !important; }
        .receipt { border: none !important; padding: 1rem !important; margin: 0 !important; }
        .dashed { border-top: 1px solid #000 !important; }
      }
    </style>
    <div class="receipt">
      <div class="center">
        <h1>SPARK AUTOMOTIVE</h1>
        <div class="info">
          <p>Plot 8, Kyanja</p>
          <p>Kampala, Uganda</p>
          <p>Tel: +254 782926508</p>
          <p>Mail: info@sparkautomotive.com</p>
        </div>
      </div>
      <div class="dashed"></div>
      <div class="details">
        <p><span>Order ID:</span> <span id="receipt-order-id">{{ order_id }}</span></p>
        <p><span>Order Type:</span> <span id="receipt-order-type">{{ order_type }}</span></p>
      </div>
      <div class="dashed"></div>
      <div class="details">
        <p class="section-title">Order Owner</p>
        <p><span>Name:</span> <span id="receipt-owner-name">{{ order_owner.name }}</span></p>
        <p><span>Email:</span> <span id="receipt-owner-email">{{ order_owner.email }}</span></p>
        <p><span>Phone:</span> <span id="receipt-owner-phone">{{ order_owner.phone }}</span></p>
      </div>
      <div class="dashed"></div>
      <div class="details">
        <p class="section-title">Order Mechanic</p>
        <p><span>Name:</span> <span id="receipt-mechanic-name">{{ order_mechanic.name }}</span></p>
      </div>
      <div class="dashed"></div>
      <div class="details">
        <p class="section-title">Vehicle</p>
        <p><span>Mileage:</span> <span id="receipt-mileage">{{ mileage }}</span></p>
        <p><span>Name:</span> <span id="receipt-vehicle-name">{{ vehicle_name }}</span></p>
        <p><span>Number Plate:</span> <span id="receipt-plate">{{ vehicle_number_plate }}</span></p>
      </div>
      <div class="dashed"></div>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody id="receiptItems">
          </tbody>
      </table>
      <div class="dashed"></div>
      <div class="summary">
        <p><span>Sub Total</span> <span>Shs.<span id="receipt-subtotal">{{ amount_to_pay|add_commas }}</span></span></p>
        <p><span>Paid</span> <span>Shs.<span id="receipt-paid">{{ amount_paid|default:0 }}</span></span></p>
        <p><span>Change</span> <span>Shs.<span id="receipt-change">{{ balance|add_commas }}</span></span></p>
      </div>
      <div class="dashed"></div>
      <div class="footer">
        <p>THANK YOU!</p>
        <p>Glad to see you again!</p>
      </div>
    </div>
  </div>

  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0 animate-fadeIn">
      <div class="text-center mb-6">
        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
        <h3 class="text-xl font-bold text-gray-800">Payment Rejected</h3>
        <p class="text-gray-600 text-sm" id="error-message">Insufficient amount paid.</p>
      </div>
      <button id="closeErrorModal" class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-orange-600 transition-colors">
        OK
      </button>
    </div>
  </div>

  <script>
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }
    `;
    document.head.appendChild(style);
  </script>

  <script type="text/javascript">
    var csrftoken = Cookies.get('csrftoken');
    function csrfSafeMethod(method) {
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });

    $(document).ready(function () {

      // Get the confirm button by its ID
      const confirmBtn = document.getElementById('confirmBtn');

      confirmBtn.addEventListener('click', function(event) {
        event.preventDefault(); // Prevents the default form submission

        // Your recordAmount logic goes here
        const url = "{% url 'record_amount_paid' order_id %}";
        const amountInput = document.getElementById('amount');
        let amount_paid_str = amountInput.value.replace(/,/g, "").trim();

        if (!amount_paid_str || isNaN(amount_paid_str)) {
          showErrorMessage("Please enter a valid amount.");
          return;
        }
        const amount_paid = parseFloat(amount_paid_str);
        if (amount_paid < 0) {
          showErrorMessage("Amount cannot be negative.");
          return;
        }

        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        confirmBtn.disabled = true;

        // **This is where you place the corrected $.ajax call**
        $.ajax({
          url: url,
          type: 'POST',
          data: { 'amount_paid': amount_paid_str },
          dataType: 'json',
        })
        .done(function(data) {
          // This block runs only on HTTP 200 OK
          handleResponse(data);
        })
        .fail(function(xhr, status, error) {
          // This block runs for ANY HTTP error status code (4xx or 5xx)
          if (xhr.responseJSON) {
            // If the server returned JSON data with the error
            handleResponse(xhr.responseJSON);
          } else if (status === 'timeout') {
            showErrorMessage("Request timed out. Please check your connection.");
          } else {
            // For other network or unknown errors
            showErrorMessage("Network error. Please try again.");
          }
        })
        .always(function() {
          // This block always runs, regardless of success or failure
          confirmBtn.innerHTML = originalText;
          confirmBtn.disabled = false;
        });
      });

      function handleResponse(data) {
        // The rest of your existing handleResponse logic...
        const confirmBtn = document.querySelector('form button');
        const originalText = 'Confirm';
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;

        if (data.status === 'ok') {
          const paidFormatted = Number(data.amount_paid).toLocaleString();
          const change = parseFloat(data.change);
          const changeFormatted = Math.abs(change).toLocaleString();

          // Update the Amount Paid and Change displays directly
          document.getElementById('amount-paid-display').textContent = paidFormatted;
          document.getElementById('change-display').textContent = changeFormatted;

          // Set the text color for change to be red if negative
          const changeDisplayEl = document.getElementById('change-display');
          if (change < 0) {
            changeDisplayEl.style.color = '#dc2626'; // Tailwind's red-600
          } else {
            changeDisplayEl.style.color = ''; // Reset to default blue
          }

          // Show the print button after a successful payment
          document.getElementById('printReceiptBtn').classList.remove('hidden');

          // Update receipt template data
          document.getElementById('receipt-paid').textContent = paidFormatted;
          document.getElementById('receipt-change').textContent = changeFormatted;
          const itemsContainer = document.getElementById('receiptItems');
          itemsContainer.innerHTML = '';
          if (data.order_items && Array.isArray(data.order_items)) {
            data.order_items.forEach(item => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${item.name || 'Unknown Service'}</td>
                <td>Shs.${(item.price || 0).toLocaleString()}</td>
              `;
              itemsContainer.appendChild(row);
            });
          }
          document.getElementById('amount').value = '';

        } else if (data.status === 'ko') {
          let errorMsg = data.error || "Payment could not be processed.";
          if (!errorMsg.trim()) errorMsg = "An unknown error occurred. Please try again.";
          showErrorMessage(errorMsg);
        } else {
          showErrorMessage("Invalid response from server. Please contact support.");
        }
      }

      document.getElementById('printReceiptBtn').onclick = function() {
        const receiptContent = document.getElementById('receiptTemplate').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Receipt</title>
            <style>${document.querySelector('#receiptTemplate style').textContent}</style>
          </head>
          <body>${receiptContent}</body>
          </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
      };

      function showErrorMessage(message) {
        document.getElementById('error-message').textContent = message;
        document.getElementById('errorModal').classList.remove('hidden');
        document.getElementById('closeErrorModal').onclick = function() {
          document.getElementById('errorModal').classList.add('hidden');
        };
        document.getElementById('errorModal').onclick = function(e) {
          if (e.target.id === 'errorModal') {
            document.getElementById('errorModal').classList.add('hidden');
          }
        };
      }
    });
</script>

  <script>
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(protocol + '://' + window.location.host + '/ws/client-screen/');

    const log = (message) => {
      console.log("LOG:", message);
      const logDiv = document.getElementById('cashier-log');
      if (!logDiv) {
        console.error("❌ Element #cashier-log not found! Check your HTML template.");
        return;
      }
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    socket.onopen = function() {
      log("🟢 Connected to WebSocket server");
    };

    socket.onmessage = function(e) {
      log("📥 Received from server: " + e.data);
    };

    socket.onerror = function(error) {
      log("❌ WebSocket Error: " + error.message);
    };

    socket.onclose = function() {
      log("🔴 WebSocket disconnected");
    };

    document.addEventListener('DOMContentLoaded', () => {
      const orderId = "{{ order_id }}";
      log("🔍 Detected Order ID: " + orderId);

      if (!orderId || orderId === "") {
        log("⚠️ Warning: No valid order ID found in context!");
        return;
      }

      log("📤 Sending 'show_order' command for: " + orderId);
      socket.send(JSON.stringify({
        action: "show_order",
        order_id: orderId
      }));
    });
  </script>

  <script>
    window.addEventListener('beforeunload', function (e) {
        navigator.sendBeacon("/reset-client-screen/");
    });
  </script>

  <script>
    const amountInput = document.getElementById("amount");

    amountInput.addEventListener("input", function (e) {
      let value = e.target.value;
      value = value.replace(/,/g, '');
      if (!isNaN(value) && value !== "") {
        const parts = value.split(".");
        parts[0] = Number(parts[0]).toLocaleString();
        e.target.value = parts.join(".");
      }
    });

    amountInput.form?.addEventListener("submit", function () {
      amountInput.value = amountInput.value.replace(/,/g, "");
    });
  </script>

</body>
</html>