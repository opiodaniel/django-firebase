{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spark Automotive — Client Screen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #fef3c7, #fed7aa); /* Warm background gradient */
    }
    .fade-in { animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Custom gradient for main content card */
    .theme-gradient-card {
        background: linear-gradient(to bottom right, #fb923c, #f97316); /* orange-400 to orange-600 */
    }
  </style>
</head>
<body class="min-h-screen ">

  <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="flex flex-col items-center justify-center mb-8 mt-4">
      <div class="rounded-full p-2 card-shadow theme-gradient-logo-bg">
           <img src="{% static 'img/logo.png' %}" alt="Spark Automotive Logo" class="w-64 object-contain" />
      </div>
      <h1 class="text-4xl font-extrabold text-orange-600 mt-4">Spark Automotive</h1>
      <p class="text-orange-500">Your Trusted Vehicle Care Partner</p>
    </div>

    <div class="rounded-2xl shadow-lg p-8 theme-gradient-card text-white">
      <div class="flex flex-col lg:flex-row gap-8">

        <div class="flex-1">
          <h2 class="text-2xl font-semibold mb-6">Company Details</h2>
          <div class="space-y-4">
            <div class="flex justify-between">
              <span class="font-medium text-white text-opacity-80">Address:</span>
              <span class="font-bold">Plot 8, Kyanja</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-white text-opacity-80">Phone:</span>
              <span class="font-bold">+256 782926508</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-white text-opacity-80">Email:</span>
              <span class="font-bold">sparkautomotiveug@gmail.com</span>
            </div>
          </div>
        </div>

        <div class="flex-1 bg-white rounded-xl p-6 text-gray-800">
          <div id="welcome" class="space-y-6">
            <div class="bg-gray-200 rounded-2xl p-6 text-center">
              <h2 class="text-2xl font-bold">Welcome!</h2>
              <p class="text-gray-600 mt-2 leading-relaxed">
                Your vehicle is being serviced.<br>Please wait here — your service details will appear automatically.
              </p>
            </div>
            <div class="mt-6 p-4 bg-gray-200 rounded-2xl inline-block">
              <span class="text-sm text-gray-600">Waiting for order selection...</span>
            </div>
          </div>

          <div id="order-details" style="display:none;" class="space-y-6 fade-in text-left">
            <h3 class="text-xl font-semibold mb-4">Financial Summary</h3>
            <div class="bg-gray-100 rounded-2xl p-6 space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-700 text-opacity-80">Client Name:</span> <strong id="client-name" class="font-medium">—</strong>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-700 text-opacity-80">Vehicle:</span> <strong id="vehicle" class="font-medium">—</strong>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-700 text-opacity-80">Phone:</span> <strong id="phone" class="font-medium">—</strong>
              </div>
              <div class="border-t border-gray-300 pt-4 mt-4 flex justify-between items-baseline">
                <span class="text-gray-700 font-semibold text-lg">Amount Due:</span>
                <strong id="amount-due" class="text-3xl text-orange-600 font-extrabold">—</strong>
              </div>
              <div class="text-sm text-gray-600 text-center">
                Order ID: <span id="order-id" class="font-mono">—</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="w-full max-w-4xl mx-auto text-center space-y-8 hidden">
    <div class="mt-4 p-4 w-full max-w-md mx-auto bg-gray-100 rounded-lg">
      <h3 class="font-semibold text-gray-800 mb-2 text-center">🔌 WebSocket Debug (Client)</h3>
      <div id="client-log" class="text-xs text-gray-600 font-mono h-32 overflow-y-auto bg-gray-50 p-2 rounded"></div>
    </div>
  </div>

  <script>
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(protocol + '://' + window.location.host + '/ws/client-screen/');

    const log = (message) => {
      const logDiv = document.getElementById('client-log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    socket.onopen = function() {
      log("🟢 Connected to WebSocket server");
    };

    socket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      log("📥 Received from server: " + e.data);

      if (data.type === "order_updated") {
        log("🎯 Received ORDER UPDATE: " + data.data.id);

        document.getElementById("welcome").style.display = "none";
        document.getElementById("order-details").style.display = "block";

        document.getElementById("client-name").textContent = data.data.client_name || "—";
        document.getElementById("vehicle").textContent = data.data.vehicle || "—";
        document.getElementById("phone").textContent = data.data.phone || "—";
        document.getElementById("order-id").textContent = data.data.id || "—";

        // --- Number Formatting Logic ---
        const amount = parseFloat(data.data.amount_due);
        if (!isNaN(amount)) {
          const formattedAmount = amount.toLocaleString('en-US'); // Formats with commas
          document.getElementById("amount-due").textContent = `Shs. ${formattedAmount}`;
        } else {
          document.getElementById("amount-due").textContent = "—";
        }
        // -------------------------------

        // Update progress bar
        if (data.data.status === 'in_progress') {
          document.getElementById('progress-bar').style.width = '50%';
          document.getElementById('progress-status').textContent = 'Service in progress...';
          document.getElementById('progress-bar').classList.remove('bg-green-500');
          document.getElementById('progress-bar').classList.add('bg-orange-500');
        } else if (data.data.status === 'completed') {
          document.getElementById('progress-bar').style.width = '100%';
          document.getElementById('progress-bar').classList.remove('bg-orange-500');
          document.getElementById('progress-bar').classList.add('bg-green-500');
          document.getElementById('progress-status').textContent = 'Service complete! Ready for pickup.';
        } else {
          document.getElementById('progress-bar').style.width = '0%';
          document.getElementById('progress-bar').classList.remove('bg-orange-500');
          document.getElementById('progress-bar').classList.remove('bg-green-500');
          document.getElementById('progress-status').textContent = 'Order received';
        }

        log("✨ UI updated with order data");
      } else if (data.type === "reset") {
        log("🎯 Received RESET message. Reverting to welcome screen.");
        document.getElementById("order-details").style.display = "none";
        document.getElementById("welcome").style.display = "block";
      } else {
        log("ℹ️ Unrecognized message type: " + data.type);
      }
    };

    socket.onerror = function(error) {
      log("❌ WebSocket Error: " + error.message);
    };

    socket.onclose = function() {
      log("🔴 WebSocket disconnected");
    };

    setInterval(() => {
      if (socket.readyState === WebSocket.OPEN) {
        log("📡 Sending ping...");
        socket.send(JSON.stringify({ action: "ping" }));
      }
    }, 30000);
  </script>

</body>
</html>