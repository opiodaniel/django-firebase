<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spark Automotive ‚Äî Client Screen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #fef3c7, #fed7aa); /* Warm background gradient */
    }
    .card-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
    }
    .fade-in { animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Custom gradient for welcome/order details card */
    .theme-gradient-card {
        background: linear-gradient(to bottom right, #fb923c, #f97316); /* orange-400 to orange-600 */
    }
    .theme-gradient-logo-bg {
        background: linear-gradient(to bottom right, #fdbf6b, #f59e0b); /* orange-300 to orange-500 */
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

  <div class="w-full max-w-4xl mx-auto text-center space-y-8">

    <div class="flex flex-col items-center justify-center">
      <div class="rounded-full p-4 card-shadow theme-gradient-logo-bg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/><path d="M15.535 8.465l-2.079 2.079 1.414 1.414 2.079-2.079-1.414-1.414z"/><path d="M8.465 15.535l-2.079-2.079-1.414 1.414 2.079 2.079 1.414-1.414z"/><path d="M12 8h-2c-1.103 0-2 .897-2 2v2c0 1.103.897 2 2 2h2v-4z"/><path d="M14 16h2c1.103 0 2-.897 2-2v-2c0-1.103-.897-2-2-2h-2v4z"/><path d="M12 10v4h2v-4h-2z"/>
        </svg>
      </div>
      <h1 class="text-4xl font-extrabold text-orange-600 mt-4">Spark Automotive</h1>
      <p class="text-orange-500">Your Trusted Vehicle Care Partner</p>
    </div>

    <div class="rounded-3xl p-8 card-shadow theme-gradient-card text-white">

      <div id="welcome" class="space-y-6">
        <div class="bg-white bg-opacity-20 rounded-2xl p-6 text-center">
          <h2 class="text-2xl font-bold text-white">Welcome!</h2>
          <p class="text-white mt-2 leading-relaxed">
            Your vehicle is being serviced.<br>Please wait here ‚Äî your service details will appear automatically.
          </p>
        </div>
        <div class="mt-6 p-4 bg-white bg-opacity-20 rounded-2xl inline-block">
          <span class="text-sm text-white">Waiting for order selection...</span>
        </div>
      </div>

      <div id="order-details" style="display:none;" class="space-y-6 fade-in text-left">
        <div class="bg-white bg-opacity-20 rounded-2xl p-4 flex items-center justify-center space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          <h2 class="text-xl font-semibold text-white">Your Service Details</h2>
        </div>

        <div class="bg-white bg-opacity-20 rounded-2xl p-6 space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-white text-opacity-80">Client Name:</span> <strong id="client-name" class="font-medium">‚Äî</strong>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-white text-opacity-80">Vehicle:</span> <strong id="vehicle" class="font-medium">‚Äî</strong>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-white text-opacity-80">Phone:</span> <strong id="phone" class="font-medium">‚Äî</strong>
          </div>
          <div class="border-t border-white border-opacity-30 pt-4 mt-4 flex justify-between items-baseline">
            <span class="text-white text-opacity-80 font-semibold text-lg">Amount Due:</span>
            <strong id="amount-due" class="text-3xl text-white font-extrabold">‚Äî</strong>
          </div>
        </div>
        <div class="text-sm text-white text-opacity-80 text-center">
          Order ID: <span id="order-id" class="font-mono">‚Äî</span>
        </div>

        <div class="mt-8">
          <h3 class="font-semibold text-white mb-2">Service Progress</h3>
          <div class="w-full bg-white bg-opacity-30 rounded-full h-2.5">
            <div id="progress-bar" class="bg-green-300 h-2.5 rounded-full" style="width: 0%;"></div>
          </div>
          <p id="progress-status" class="text-sm text-white text-opacity-80 mt-2">
            Order received
          </p>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-auto py-8 text-center text-orange-700 text-sm">
    <p>Thank you for choosing Spark Automotive</p>
    <p>üìç Plot 8, Kyanja, Kampala‚Ä¢ üìû +254 782926508</p>
  </footer>

  <div class="mt-4 p-4 w-full max-w-md mx-auto bg-gray-100 rounded-lg">
    <h3 class="font-semibold text-gray-800 mb-2 text-center">üîå WebSocket Debug (Client)</h3>
    <div id="client-log" class="text-xs text-gray-600 font-mono h-32 overflow-y-auto bg-gray-50 p-2 rounded"></div>
  </div>

  <script>
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(protocol + '://' + window.location.host + '/ws/client-screen/');

    const log = (message) => {
      const logDiv = document.getElementById('client-log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    socket.onopen = function() {
      log("üü¢ Connected to WebSocket server");
    };

    socket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      log("üì• Received from server: " + e.data);

      if (data.type === "order_updated") {
        log("üéØ Received ORDER UPDATE: " + data.data.id);

        document.getElementById("welcome").style.display = "none";
        document.getElementById("order-details").style.display = "block";

        document.getElementById("client-name").textContent = data.data.client_name || "‚Äî";
        document.getElementById("vehicle").textContent = data.data.vehicle || "‚Äî";
        document.getElementById("phone").textContent = data.data.phone || "‚Äî";
        document.getElementById("order-id").textContent = data.data.id || "‚Äî";

        // --- Number Formatting Logic ---
        const amount = parseFloat(data.data.amount_due);
        if (!isNaN(amount)) {
          const formattedAmount = amount.toLocaleString('en-US'); // Formats with commas
          document.getElementById("amount-due").textContent = `${formattedAmount} shs.`;
        } else {
          document.getElementById("amount-due").textContent = "‚Äî";
        }
        // -------------------------------

        // Update progress bar
        if (data.data.status === 'in_progress') {
          document.getElementById('progress-bar').style.width = '50%';
          document.getElementById('progress-status').textContent = 'Service in progress...';
        } else if (data.data.status === 'completed') {
          document.getElementById('progress-bar').style.width = '100%';
          document.getElementById('progress-status').textContent = 'Service complete! Ready for pickup.';
        } else {
          document.getElementById('progress-bar').style.width = '0%';
          document.getElementById('progress-status').textContent = 'Order received';
        }

        log("‚ú® UI updated with order data");
      } else if (data.type === "reset") {
        log("üéØ Received RESET message. Reverting to welcome screen.");
        document.getElementById("order-details").style.display = "none";
        document.getElementById("welcome").style.display = "block";
      } else {
        log("‚ÑπÔ∏è Unrecognized message type: " + data.type);
      }
    };

    socket.onerror = function(error) {
      log("‚ùå WebSocket Error: " + error.message);
    };

    socket.onclose = function() {
      log("üî¥ WebSocket disconnected");
    };

    setInterval(() => {
      if (socket.readyState === WebSocket.OPEN) {
        log("üì° Sending ping...");
        socket.send(JSON.stringify({ action: "ping" }));
      }
    }, 30000);
  </script>

</body>
</html>